!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.SyncManager=t():e.SyncManager=t()}(window,function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var a=t[r]={i:r,l:!1,exports:{}};return e[r].call(a.exports,a,a.exports,n),a.l=!0,a.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)n.d(r,a,function(t){return e[t]}.bind(null,a));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=1)}([function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();var a=function(e){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.name="SyncManagerException",n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,Error),r(t,null,[{key:"throw",value:function(e){console.error(e)}}]),t}();t.default=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=c(n(2)),i=c(n(7)),u=c(n(11)),s=c(n(3)),o=c(n(0));function c(e){return e&&e.__esModule?e:{default:e}}var l=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return r(e,null,[{key:"init",value:function(t,n){"function"==typeof t&&(n=t,t={}),e.LocalDB&&(e.LocalDB.close(),e.LocalDB=null);var r=new a.default("sbsync.db",1);r.schema("GroupChannel",{key:"url",index:["lastMessageUpdatedAt","createdAt","name"]}).schema("MessageChunk",{key:"chunkId",index:["channelUrl","filterKey","endAt"]}).schema("Message",{key:"messageId",index:["channelUrl","createdAt"]}).build().then(function(){e.LocalDB=r,e.Channel=i.default,e.Message=u.default,e.ChangeLog=s.default,e.Exception=o.default,n()})}},{key:"start",value:function(){var t=e.Channel.instance;t&&t.start();var n=e.Message.instance;n&&n.start()}},{key:"stop",value:function(){var t=e.Channel.instance;t&&t.stop();var n=e.Message.instance;n&&n.stop()}},{key:"reset",value:function(){var t=e.Channel.instance;t&&t.reset();var n=e.Message.instance;n&&n.reset()}}]),e}();t.default=l},function(e,t,n){"use strict";(function(e){var n,r,a,i,u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};"undefined"!=typeof self&&self,i=function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var a=t[r]={i:r,l:!1,exports:{}};return e[r].call(a.exports,a,a.exports,n),a.l=!0,a.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:r})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=u(n(2)),i=u(n(3));function u(e){return e&&e.__esModule?e:{default:e}}var s=new WeakMap,o=new WeakMap,c=new WeakMap,l=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.msIndexedDB,f=function(){function e(t,n){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!l)throw new Error("IndexedDB is not supported in this environment. Check if you're in web browser which supports IndexedDB.");this.name=t,this.version=n,s.set(this,{}),o.set(this,null),c.set(this,{})}return r(e,null,[{key:"Query",get:function(){return i.default}}]),r(e,[{key:"schema",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return s.get(this)[e]=t,this}},{key:"build",value:function(){var e=this,t=s.get(this),n=c.get(this);return new Promise(function(r,i){var u=l.open(e.name,e.version);u.onerror=function(e){i(new Error("IndexedDB is not available: "+e.target.errorCode))},u.onupgradeneeded=function(r){var i=r.target.result,u=r.target.transaction,s=u.objectStoreNames;for(var c in t){var l=t[c].key||"id",f=null;try{f=u.objectStore(c)}catch(e){"NotFoundError"===e.name&&(f=i.createObjectStore(c,{keyPath:l}))}if(f){var h=f.indexNames,d=new a.default(i,c,l);if(t[c].index&&t[c].index.length>0)for(var v in t[c].index)if("string"==typeof t[c].index[v]){var y=t[c].index[v],m=!1;for(var p in h)if(h[p]===y){m=!0;break}m||f.createIndex(y,t[c].index[v],{unique:!1})}for(var g=0;g<h.length;g++)t[c].index&&t[c].index!==h[g]||f.deleteIndex(h[g]);n[c]=d}}for(var b=0;b<s.length;b++)Object.keys(t).indexOf(s.item(b))<0&&i.deleteObjectStore(s.item(b));o.set(e,i)},u.onsuccess=function(i){var u=i.target.result;for(var s in t)if(!n[s]){var c=t[s].key||"id";n[s]=new a.default(u,s,c)}o.set(e,u),r()}})}},{key:"close",value:function(){var e=o.get(this);e&&(e.close(),o.set(this,null))}},{key:"drop",value:function(){l.deleteDatabase(this.name)}},{key:"collection",value:function(e){var t=c.get(this);return t[e]&&t[e]instanceof a.default?t[e]:null}}]),e}();t.default=f},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var r="function"==typeof Symbol&&"symbol"==u(Symbol.iterator)?function(e){return void 0===e?"undefined":u(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":void 0===e?"undefined":u(e)};t.deepEqual=function e(t,n){var a=void 0===t?"undefined":r(t),i=void 0===n?"undefined":r(n);return!t||!n||"object"!==a||a!==i||t instanceof Date?t instanceof Date?t.getTime()===n.getTime():"function"===a&&"function"===i||t===n:Object.keys(t).length===Object.keys(n).length&&Object.keys(t).every(function(r){return e(t[r],n[r])})}},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var r="function"==typeof Symbol&&"symbol"==u(Symbol.iterator)?function(e){return void 0===e?"undefined":u(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":void 0===e?"undefined":u(e)},a=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=function(e){return e&&e.__esModule?e:{default:e}}(n(0)),s=n(1),o=new WeakMap,c=function(){function e(t,n,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.name=n,this.keyPath=r,o.set(this,t)}return a(e,[{key:"findById",value:function(e){var t=this,n=o.get(this);return new Promise(function(r,a){var i=n.transaction(t.name,"readonly").objectStore(t.name).get(e);i.onsuccess=function(){r(i.result||null)},i.onerror=function(){a(i.error)}})}},{key:"find",value:function(e){var t=this,n=o.get(this);return new Promise(function(r,a){if(e instanceof i.default.Query){var u=[],s=n.transaction(t.name,"readonly").objectStore(t.name),o=e.orderBy?s.index(e.orderBy).openCursor(null,e.desc?"prev":"next"):s.openCursor(),c=e.offset;o.onsuccess=function(t){var n=t.target.result;if(n)if(!c||c<0){var a=n.value;e.match(a)?(u.push(a),u.length<e.limit?n.continue():r(u)):n.continue()}else c--,n.continue();else r(u)},o.onerror=function(){a(o.error)}}else a(new Error("Invalid type: 'query' should be LocalDB.Query type."))})}},{key:"count",value:function(e){var t=this,n=o.get(this);return new Promise(function(r,a){if(!e||e instanceof i.default.Query){var u=n.transaction(t.name,"readonly").objectStore(t.name);if(e){var s=0,o=u.openCursor();o.onsuccess=function(){var t=event.target.result;t?(e.match(t.value)&&s++,t.continue()):r(s)},o.onerror=function(){a(o.error)}}else{var c=u.count();c.onsuccess=function(){r(c.result)},c.onerror=function(){a(c.error)}}}else a(new Error("Invalid type: 'query' should be LocalDB.Query type."))})}},{key:"insert",value:function(e){var t=this,n=o.get(this);return new Promise(function(a,i){var u=n.transaction(t.name,"readwrite").objectStore(t.name);if(Array.isArray(e))!function(){var t=[],n=function(n){var r=e[n],s=u.add(r);s.onsuccess=function(){t.push(r),t.length===e.length&&a(t)},s.onerror=function(){i(s.error)}};for(var r in e)n(r)}();else if(e&&"object"===(void 0===e?"undefined":r(e))){var s=u.add(e);s.onsuccess=function(){a(e)},s.onerror=function(){i(s.error)}}else i(new Error("Invalid type: 'item' should be an object or an object array."))})}},{key:"upsert",value:function(e){var t=this,n=o.get(this);return new Promise(function(a,i){var u=n.transaction(t.name,"readwrite").objectStore(t.name);if(e&&"object"===(void 0===e?"undefined":r(e))){var s=u.get(e[t.keyPath]);s.onsuccess=function(){if(s.result){var t=u.put(e);t.onsuccess=function(){return a(e)},t.onerror=function(){return i(t.error)}}else{var n=u.add(e);n.onsuccess=function(){return a(e)},n.onerror=function(){return i(n.error)}}},s.onerror=function(){i(s.error)}}else i(new Error("Invalid type: 'item' should be an object or an object array."))})}},{key:"update",value:function(e){var t=this,n=o.get(this);return new Promise(function(r,a){var i=n.transaction(t.name,"readwrite").objectStore(t.name).put(e);i.onsuccess=function(){r(e)},i.onerror=function(){a(i.error)}})}},{key:"updateIf",value:function(e,t){var n=this,r=o.get(this);return new Promise(function(a,u){if(e instanceof i.default.Query){var o=[],c=r.transaction(n.name,"readwrite").objectStore(n.name),l=c.openCursor();l.onsuccess=function(n){var r=n.target.result;if(r){var i=r.value;if(e.match(i)){var l=!1;for(var f in t){var h=t[f];(0,s.deepEqual)(i[f],h)||(l=!0,i[f]=h)}if(l){var d=c.put(i);d.onsuccess=function(){o.push(i),r.continue()},d.onerror=function(){u(d.error)}}else r.continue()}else r.continue()}else a(o)},l.onerror=function(){u(l.error)}}else u(new Error("Invalid type: 'query' should be LocalDB.Query type."))})}},{key:"remove",value:function(e){var t=this,n=o.get(this);return new Promise(function(r,a){var i=n.transaction(t.name,"readwrite").objectStore(t.name).delete(e);i.onsuccess=function(){r()},i.onerror=function(){a(i.error)}})}},{key:"removeIf",value:function(e){var t=this,n=o.get(this);return new Promise(function(r,a){if(e instanceof i.default.Query){var u=[],s=n.transaction(t.name,"readwrite").objectStore(t.name),o=s.openCursor();o.onsuccess=function(){var n=event.target.result;if(n){var i=n.value;if(e.match(i)){var o=s.delete(i[t.keyPath]);o.onsuccess=function(){u.push(i),n.continue()},o.onerror=function(){a(o.error)}}else n.continue()}else r(u)},o.onerror=function(){a(o.error)}}else a(new Error("Invalid type: 'query' should be LocalDB.Query type."))})}},{key:"clear",value:function(){var e=this,t=o.get(this);return new Promise(function(n,r){var a=t.transaction(e.name,"readwrite").objectStore(e.name).clear();a.onsuccess=function(){n()},a.onerror=function(){r(a.error)}})}}]),e}();t.default=c},function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a="function"==typeof Symbol&&"symbol"==u(Symbol.iterator)?function(e){return void 0===e?"undefined":u(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":void 0===e?"undefined":u(e)},i=n(1),s=1/0,o=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.condition=t,this.offset=0,this.limit=s,this.orderBy=null,this.desc=!1}return r(e,null,[{key:"and",value:function(){for(var t=arguments.length,n=Array(t),r=0;r<t;r++)n[r]=arguments[r];return n.length>0?new e({"/and":n}):new e({})}},{key:"or",value:function(){for(var t=arguments.length,n=Array(t),r=0;r<t;r++)n[r]=arguments[r];return n.length>0?new e({"/or":n}):new e({})}}]),r(e,[{key:"match",value:function(e){return function e(t,n){var r=!0;for(var u in n){switch(u){case"/and":r=r&&n[u].reduce(function(n,r){return r&&e(t,n)});break;case"/or":r=r&&n[u].reduce(function(n,r){return r||e(t,n)});break;default:var s=n[u];if("object"===(void 0===s?"undefined":a(s)))for(var o in s)switch(o){case">":r=r&&t[u]>s[o];break;case">=":r=r&&t[u]>=s[o];break;case"<":r=r&&t[u]<s[o];break;case"<=":r=r&&t[u]<=s[o];break;case"=":r=r&&t[u]===s[o];break;case"!=":r=r&&t[u]!==s[o];break;case"/in":r=r&&Array.isArray(s[o])&&s[o].indexOf(t[u])>=0;break;case"/nin":r=r&&Array.isArray(s[o])&&s[o].indexOf(t[u])<0;break;case"/regex":r=r&&s[o]instanceof RegExp&&s[o].test(t[u]);break;case"/where":r=r&&s[o](t[u]);break;default:r=r&&(0,i.deepEqual)(t[u],s)}else r=r&&t[u]===s}if(!r)break}return r}(e,this.condition)}}]),e}();t.default=o}]).default},"object"==u(t)&&"object"==u(e)?e.exports=i():(r=[],void 0===(a="function"==typeof(n=i)?n.apply(t,r):n)||(e.exports=a))}).call(this,n(6)(e))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();var a=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.taskNumber=t.taskNumber,this.action=t.action||e.Action.NOOP,this.item=t.item}return r(e,null,[{key:"Action",get:function(){return{NOOP:"noop",INSERT:"insert",UPDATE:"update",REMOVE:"remove",MOVE:"move",CLEAR:"clear"}}}]),e}();t.default=a},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MessageChunkContainer=t.MessageChunk=void 0;var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=s(n(1)),i=s(n(2)),u=n(13);function s(e){return e&&e.__esModule?e:{default:e}}var o={},c=function(e){var t=[];for(var n in e)t.push(n+"="+e[n]);return t.join("&")},l=t.MessageChunk=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.chunkId=(0,u.createId)(),this.channelUrl=t,this.filterKey=c(n),this.filter=n,this.isSynced=!1,this.startAt=(new Date).getTime(),this.endAt=0}return r(e,[{key:"hasDefaultFilter",value:function(){var t=e.getDefaultFilter();return(0,u.deepEqual)(this.filter,t)}},{key:"isOverlap",value:function(e){return e.startAt<=this.startAt&&this.startAt<=e.endAt||e.startAt<=this.endAt&&this.endAt<=e.endAt}},{key:"isSame",value:function(e){return e.startAt===this.startAt&&this.endAt===e.endAt}},{key:"containsMessage",value:function(e){return this.startAt<=e.createdAt&&e.createdAt<=this.endAt}},{key:"serialize",value:function(){return JSON.parse(JSON.stringify(this))}},{key:"extendWithChunk",value:function(e){return this.extendForwardWithChunk(e),this.extendBackwardWithChunk(e),this}},{key:"extendForwardWithChunk",value:function(e){return this.endAt=Math.max(this.endAt,e.endAt),this}},{key:"extendBackwardWithChunk",value:function(e){return this.startAt=Math.min(this.startAt,e.startAt),this}},{key:"extendWithMessage",value:function(e){return this.extendForwardWithMessage(e),this.extendBackwardWithMessage(e),this}},{key:"extendForwardWithMessage",value:function(e){return this.endAt=Math.max(this.endAt,e.createdAt),this}},{key:"extendBackwardWithMessage",value:function(e){return this.startAt=Math.min(this.startAt,e.createdAt),this}}],[{key:"createFromJson",value:function(t){var n=new e(t.channelUrl,t.filter);return n.chunkId=t.chunkId,n.startAt=t.startAt,n.endAt=t.endAt,n}},{key:"getDefaultFilter",value:function(){return{messageTypeFilter:null,customTypeFilter:null,senderUserIdsFilter:[]}}}]),e}();t.MessageChunkContainer=function(){var e=this,t=a.default.LocalDB.collection("MessageChunk");return this.query=function(e,n){return new Promise(function(r,a){var u=new i.default.Query(e);n&&(u.offset=n.offset||0,u.limit=n.limit||20,u.orderBy=n.orderBy||"endAt",u.desc=!n.hasOwnProperty("desc")||n.desc),t.find(u).then(function(e){var t=[];for(var n in e){var a=l.createFromJson(e[n]);t.push(a),o[a.chunkId]=a}r(t)}).catch(a)})},this.upsert=function(e){return new Promise(function(n,r){(function(e){return o[e.chunkId]=e,t.upsert(o[e.chunkId].serialize())})(e).then(function(e){return n(l.createFromJson(e))}).catch(r)})},this.remove=function(e){return new Promise(function(n,r){(function(e){return o[e]&&delete o[e],t.remove(e)})(e).then(function(){return n(e)}).catch(r)})},this.clear=function(){return o={},t.clear()},this.getLatestChunkByTimestamp=function(n,r,a){return new Promise(function(u,s){var o=new i.default.Query({channelUrl:n,filterKey:c(r),startAt:{"<=":a}});o.limit=1,o.orderBy="endAt",o.desc=!0,t.find(o).then(function(r){var o=r.length>0?l.createFromJson(r[0]):null;if(o)if(o.hasDefaultFilter())u(o);else{var f=new i.default.Query({channelUrl:n,filterKey:c(l.getDefaultFilter()),startAt:{"<=":a}});f.limit=1,f.orderBy="endAt",f.desc=!0,t.find(f).then(function(t){var n=t.length>0?l.createFromJson(t[0]):null;if(n)if(n.endAt>o.endAt)if(n.isOverlap(o))o.extendWithChunk(n),e.upsert(o).then(u).catch(s);else{var r=new l(o.channelUrl,o.filter);r.startAt=n.startAt,r.endAt=n.endAt,e.upsert(r).then(u).catch(s)}else u(o);else u(o)}).catch(s)}else u(null)}).catch(s)})},this.mergePreviousChunkOverlap=function(n){return new Promise(function(r,a){var u=new i.default.Query({chunkId:{"!=":n.chunkId},channelUrl:n.channelUrl,filterKey:n.filterKey,endAt:{">=":n.startAt}});u.limit=1/0,t.find(u).then(function(u){if(u.length>0){var s=new i.default.Query({chunkId:{"/in":u.map(function(e){return e.chunkId})}});t.removeIf(s).then(function(){for(var t in u)n.extendWithChunk(u[t]);e.upsert(n).then(r).catch(a)}).catch(a)}else r()}).catch(a)})},this}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();var a=6e4,i=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.locked=!1,this.lockedAt=(new Date).getTime()+a}return r(e,[{key:"isLocked",value:function(){return this.locked}},{key:"lock",value:function(e){var t=this;this.locked?setTimeout(function(){(new Date).getTime()-t.lockedAt<a&&t.lock(e)},200):(this.locked=!0,this.lockedAt=(new Date).getTime(),e(function(){return t.unlock()}))}},{key:"unlock",value:function(){this.locked=!1,this.lockedAt=(new Date).getTime()+a}}]),e}();t.default=i},function(e,t){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children||(e.children=[]),Object.defineProperty(e,"loaded",{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,"id",{enumerable:!0,get:function(){return e.i}}),e.webpackPolyfill=1),e}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=o(n(8)),i=n(9),u=n(10),s=o(n(0));function o(e){return e&&e.__esModule?e:{default:e}}var c=null,l=new WeakMap,f=new WeakMap,h=new WeakMap,d="syncManager_channelManager_connectionHandler_"+(new Date).getTime(),v="syncManager_channelManager_channelHandler_"+(new Date).getTime(),y=function(){function e(t){var n=this;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!c){c=this;var r=this.sb=t,a=new i.ChannelContainer(r),o=new u.ChannelBroadcast;l.set(this,[]),f.set(this,a),h.set(this,o);var y=new r.ConnectionHandler;y.onReconnectStarted=function(){o.pause()},y.onReconnectSucceeded=function(){o.reset()},r.addConnectionHandler(d,y);var m=new r.ChannelHandler;Object.keys(m).forEach(function(e){m[e]=function(){for(var t=arguments.length,i=Array(t),u=0;u<t;u++)i[u]=arguments[u];var c=l.get(n);if(Array.isArray(c))switch(e){case"onUserMuted":case"onUserUnmuted":case"onUserUnbanned":case"onChannelChanged":case"onChannelFrozen":case"onChannelUnfrozen":case"onMetaDataCreated":case"onMetaDataUpdated":case"onMetaDataDeleted":case"onMetaCountersCreated":case"onMetaCountersUpdated":case"onMetaCountersDeleted":a.upsert(i[0]).then(function(e){return o.upsert(e)}).catch(function(e){return s.default.throw(e)});break;case"onReadReceiptUpdated":a.upsert(i[0]).then(function(){}).catch(function(e){return s.default.throw(e)});break;case"onUserReceivedInvitation":case"onUserJoined":a.upsert(i[0]).then(function(e){var t=i[1];r.currentUser&&t.userId===r.currentUser.userId&&o.upsert(e)}).catch(function(e){return s.default.throw(e)});break;case"onChannelHidden":var f=i[0];a.remove(f).then(function(){return o.remove(f)}).catch(function(e){return s.default.throw(e)});break;case"onUserLeft":case"onUserBanned":var h=i[0],d=i[1];r.currentUser&&d.userId===r.currentUser.userId?a.remove(h).then(function(){return o.remove(h)}).catch(function(e){return s.default.throw(e)}):a.upsert(h).then(function(e){return o.upsert(e)}).catch(function(e){return s.default.throw(e)});break;case"onUserDeclinedInvitation":var v=i[0],y=i[2];r.currentUser&&y.userId===r.currentUser.userId?a.remove(v).then(function(){return o.remove(v)}).catch(function(e){return s.default.throw(e)}):a.upsert(v).then(function(e){return o.upsert(e)}).catch(function(e){return s.default.throw(e)});break;case"onChannelDeleted":var m=i[0];a.remove(m).then(function(){return o.remove(m)}).catch(function(e){return s.default.throw(e)})}}}),r.addChannelHandler(v,m)}return c}return r(e,[{key:"createMyGroupChannelCollection",value:function(e){var t=h.get(this),n=new a.default({manager:this,broadcast:t,channelContainer:f.get(this),type:"MyGroupChannelListQuery",query:e});n&&h.get(this).addCollection(n);return n}},{key:"createPublicGroupChannelCollection",value:function(e){var t=h.get(this),n=new a.default({manager:this,broadcast:t,channelContainer:f.get(this),type:"PublicGroupChannelListQuery",query:e});return n&&t.addCollection(n),n}},{key:"removeChannelCollection",value:function(e){h.get(this).removeCollection(e)}},{key:"clearCache",value:function(){f.get(this).clear()}},{key:"start",value:function(){h.get(this).reset()}},{key:"stop",value:function(){h.get(this).pause()}},{key:"reset",value:function(){c&&(c.clearCache(),c.sb.removeConnectionHandler(d),c.sb.removeChannelHandler(v),c=null)}}],[{key:"instance",get:function(){return c}}]),e}();t.default=y},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=s(n(5)),i=s(n(0)),u=s(n(3));function s(e){return e&&e.__esModule?e:{default:e}}var o=new WeakMap,c=new WeakMap,l=new WeakMap,f=function(){function e(t){var n=t.manager,r=t.broadcast,i=t.channelContainer,u=t.type,s=t.query;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.manager=n,this.type=u,this.query=s,this.isSynced=!1,this.isLoading=!1,this.channels=[],this.handlers={},this.mutex=new a.default;var f=0;o.set(this,function(){return++f}),c.set(this,r),l.set(this,i)}return r(e,[{key:"_pause",value:function(){this.isSynced=!1,this.isLoading=!1}},{key:"_reset",value:function(){var e=this.query;switch(this.type){case"MyGroupChannelListQuery":this.query=new this.manager.sb.GroupChannel.createMyGroupChannelListQuery;break;case"PublicGroupChannelListQuery":this.query=new this.manager.sb.GroupChannel.createPublicGroupChannelListQuery}for(var t in e)"function"!=typeof e[t]&&(this.query[t]=e[t]);this.loadChannels()}},{key:"getIndex",value:function(e){return(arguments.length>1&&void 0!==arguments[1]?arguments[1]:[]).map(function(e){return e.url}).indexOf(e.url)}},{key:"findIndex",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=null,r=!1,a=t.length;switch(this.query.order){case"latest_last_message":n="lastMessageUpdatedAt",r=!0;break;case"chronological":n="createdAt",r=!0;break;case"channel_name_alphabetical":n="name";break;default:n="lastMessageUpdatedAt",r=!0}for(var i=0;i<t.length;i++){var u=t[i];if(e.url===u.url){a=i;break}if(r&&e[n]>u[n]||!r&&e[n]<u[n]){a=i;break}}return a}},{key:"isMatchingWithQuery",value:function(e){var t=this.manager.sb,n=!0;if(e.isGroupChannel()&&!e.isSuper){if(this.query.nicknameContainsFilter){var r=!1;for(var a in e.members)if(e.members[a].nickname.indexOf(this.query.nicknameContainsFilter)>=0){r=!0;break}if(!r)return!1}if(this.query.userIdsFilter.length>0){var i=!1,u=e.members.map(function(e){return e.userId}),s=this.query.userIdsFilterExactMatch,o=this.query.queryType;if(s?i=u.length===this.query.userIdsFilter.length&&this.query.userIdsFilter.every(function(e){return u.indexOf(e)>=0}):"AND"===o?i=this.query.userIdsFilter.every(function(e){return u.indexOf(e)>=0}):"OR"===o&&(i=this.query.userIdsFilter.reduce(function(e,t){return e||u.indexOf(t)>=0},!1)),!i)return!1}}if(this.query.channelNameContainsFilter&&(n=n&&e.name.indexOf(this.query.channelNameContainsFilter)>=0),this.query.channelUrlsFilter.length>0&&(n=n&&this.query.channelUrlsFilter.indexOf(e.url)>=0),this.query.memberStateFilter!==t.GroupChannel.memberStateFilter.ALL)switch(this.query.memberStateFilter){case t.GroupChannel.memberStateFilter.JOINED:n=n&&e.myMemberState===t.GroupChannel.memberStateFilter.JOINED;break;case t.GroupChannel.memberStateFilter.INVITED:case t.GroupChannel.memberStateFilter.INVITED_BY_FRIEND:case t.GroupChannel.memberStateFilter.INVITED_BY_NON_FRIEND:n=n&&e.myMemberState===t.GroupChannel.memberStateFilter.INVITED}if(this.query.customTypesFilter.length>0&&(n=n&&this.query.customTypesFilter.indexOf(e.customType)>=0),this.query.customTypeStartsWithFilter&&(n=n&&e.customType.startsWith(this.query.customTypeStartsWithFilter)),"all"!==this.query.superChannelFilter)switch(this.query.superChannelFilter){case t.GroupChannel.superChannelFilter.SUPER:n=n&&e.isSuper;break;case t.GroupChannel.superChannelFilter.NONSUPER:n=n&&!e.isSuper}if("all"!==this.query.publicChannelFilter)switch(this.query.publicChannelFilter){case t.GroupChannel.publicChannelFilter.PUBLIC:n=n&&e.isPublic;break;case t.GroupChannel.publicChannelFilter.PRIVATE:n=n&&!e.isPublic}return n}},{key:"_loadChannelsFromCache",value:function(e){var t=this;if(0===this.channels.length){var n=l.get(this),r=this.manager.sb,a={};if(this.query.nicknameContainsFilter&&(a.members={"/where":function(e){for(var n in e)if(e[n].nickname.indexOf(t.query.nicknameContainsFilter)>=0)return!0;return!1}}),this.query.userIdsFilter.length>0&&(a.members={"/where":function(e){var n=e.map(function(e){return e.userId});return t.query.userIdsFilterExactMatch?n.length===t.query.userIdsFilter.length&&t.query.userIdsFilter.every(function(e){return n.indexOf(e)>=0}):"AND"===t.query.queryType?t.query.userIdsFilter.every(function(e){return n.indexOf(e)>=0}):"OR"===t.query.queryType&&t.query.userIdsFilter.reduce(function(e,t){return e||n.indexOf(t)>=0},!1)}}),this.query.channelNameContainsFilter&&(a.name={"/regex":new RegExp(this.query.channelNameContainsFilter)}),this.query.channelUrlsFilter.length>0&&(a.url={"/in":this.query.channelUrlsFilter}),this.query.memberStateFilter!==r.GroupChannel.memberStateFilter.ALL)switch(this.query.memberStateFilter){case r.GroupChannel.memberStateFilter.JOINED:a.myMemberState=r.GroupChannel.memberStateFilter.JOINED;break;case r.GroupChannel.memberStateFilter.INVITED:case r.GroupChannel.memberStateFilter.INVITED_BY_FRIEND:case r.GroupChannel.memberStateFilter.INVITED_BY_NON_FRIEND:a.myMemberState={"/in":[r.GroupChannel.memberStateFilter.INVITED,r.GroupChannel.memberStateFilter.INVITED_BY_FRIEND,r.GroupChannel.memberStateFilter.INVITED_BY_NON_FRIEND]}}if("string"==typeof this.query.customTypeFilter&&this.query.customTypeFilter&&(a.customType=this.query.customTypeFilter),Array.isArray(this.query.customTypesFilter)&&this.query.customTypesFilter.length>0&&(a.customType={"/in":this.query.customTypesFilter}),"string"==typeof this.query.customTypeStartsWithFilter&&this.query.customTypeStartsWithFilter&&(a.customType={"/regex":new RegExp("^"+this.query.customTypeStartsWithFilter)}),"all"!==this.query.superChannelFilter)switch(this.query.superChannelFilter){case r.GroupChannel.superChannelFilter.SUPER:a.isSuper=!0;break;case r.GroupChannel.superChannelFilter.NONSUPER:a.isSuper=!1}if("all"!==this.query.publicChannelFilter)switch(this.query.publicChannelFilter){case r.GroupChannel.publicChannelFilter.PUBLIC:a.isPublic=!0;break;case r.GroupChannel.publicChannelFilter.PRIVATE:a.isPublic=!1}var i=null,u=!1;switch(this.query.order){case"latest_last_message":i="lastMessageUpdatedAt",u=!0;break;case"chronological":i="createdAt",u=!0;break;case"channel_name_alphabetical":i="name";break;default:i="lastMessageUpdatedAt",u=!0}n.query(a,{orderBy:i,desc:u,offset:this.channels.length,limit:this.query.limit}).then(function(t){return e(null,t)}).catch(function(t){return e(t)})}else e(null,[])}},{key:"loadChannels",value:function(e){var t=this;e||(e=function(){}),this.isLoading?e(null):(this.isLoading=!0,this._loadChannelsFromCache(function(n,r){if(r)for(var a in r){var s=t.channels.map(function(e){return e.url}).indexOf(r[a].url);(s<0||!t.channels[s].isEqual(r[a]))&&t._addViewItem(r[a])}if(t.query.hasNext){var f=t.manager.sb;t.query.next(function(n,r){var a=f.getConnectionState()===f.ConnectionState.OPEN;if(f.getErrorFirstCallback()){var i=n;n=r,r=i}if(Array.isArray(n)){var s=c.get(t),h=l.get(t),d=[];n.forEach(function(e){d.push(new Promise(function(n,r){h.getItem(e.url).then(function(a){var i=t.channels.map(function(e){return e.url}).indexOf(e.url)>=0;h.upsert(e).then(function(e){var r=!a||!a.isEqual(e);r&&s.update(e,t),i&&!r||t._addViewItem(e),n()}).catch(r)}).catch(r)}))}),Promise.all(d).then(function(){t.isSynced||(t.mutex.lock(function(e){var r=n.map(function(e){return e.url});for(var a in t.channels)if(r.indexOf(t.channels[a].url)<0){var i=o.get(t)(),s=u.default.Action.REMOVE;for(var c in t.handlers)"function"==typeof t.handlers[c]&&t.handlers[c](new u.default({taskNumber:i,action:s,item:t.channels[a]}))}e()}),t.isSynced=a),t.isLoading=!1,e(null)}).catch(function(n){t.isLoading=!1,e(n)})}else t.isLoading=!1,e(r)})}else t.isLoading=!1,e(new i.default("Channel: Connection required"))}))}},{key:"_addViewItem",value:function(e){var t=this;this.mutex.lock(function(n){var r=o.get(t)(),a=t.getIndex(e,t.channels),i=t.findIndex(e,t.channels),s=a<0?u.default.Action.INSERT:u.default.Action.UPDATE;for(var c in a<0?i<t.channels.length?t.channels.splice(i,0,e):t.channels.push(e):a!==i?(s=u.default.Action.MOVE,t.channels.splice(a,1),i>a?t.channels.splice(i-1,0,e):t.channels.splice(i,0,e)):t.channels[a]=e,t.handlers)"function"==typeof t.handlers[c]&&t.handlers[c](new u.default({taskNumber:r,action:s,item:e}));n()})}},{key:"_removeViewItem",value:function(e){var t=this;this.mutex.lock(function(n){for(var r in t.channels)if(e.url===t.channels[r].url){t.channels.splice(r,1);var a=o.get(t)(),i=u.default.Action.REMOVE;for(var s in t.handlers)"function"==typeof t.handlers[s]&&t.handlers[s](new u.default({taskNumber:a,action:i,item:e}));break}n()})}},{key:"subscribe",value:function(e,t){this.handlers[e]=t}},{key:"unsubscribe",value:function(e){this.handlers[e]&&delete this.handlers[e]}}]),e}();t.default=f},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ChannelContainer=void 0;var r=i(n(1)),a=i(n(2));function i(e){return e&&e.__esModule?e:{default:e}}var u={};t.ChannelContainer=function(e){var t=r.default.LocalDB.collection("GroupChannel"),n=function(t){if(t){var n=e.GroupChannel.buildFromSerializedData(t);return n.lastMessageUpdatedAt=n.lastMessage?n.lastMessage.createdAt:n.createdAt,n}return null};return this.query=function(e,r){return new Promise(function(i,s){var o=new a.default.Query(e);r&&(o.offset=r.offset||0,o.limit=r.limit||20,o.orderBy=r.orderBy||"lastMessageUpdatedAt",o.desc=!r.hasOwnProperty("desc")||r.desc),t.find(o).then(function(e){var t=[];for(var r in e){var a=n(e[r]);t.push(a),u[a.url]=a}i(t)}).catch(s)})},this.upsert=function(e){return new Promise(function(r,a){(function(e){return new Promise(function(n,r){var a=e.lastMessage?e.lastMessage.createdAt:e.createdAt;u[e.url]?u[e.url].lastMessageUpdatedAt<=a?(e.lastMessageUpdatedAt=a,u[e.url]=e,t.upsert(u[e.url].serialize()).then(n).catch(r)):n(u[e.url]):(e.lastMessageUpdatedAt=a,u[e.url]=e,t.upsert(u[e.url].serialize()).then(n).catch(r))})})(e).then(function(e){return r(n(e))}).catch(a)})},this.remove=function(e){return new Promise(function(i,s){(function(e){return new Promise(function(n,i){u[e.url]&&delete u[e.url],t.remove(e.url).then(function(){var t=new a.default.Query({channelUrl:e.url});r.default.LocalDB.collection("MessageChunk").removeIf(t).then(function(){r.default.LocalDB.collection("Message").removeIf(t).then(n).catch(i)}).catch(i)}).catch(i)})})(e).then(function(e){return i(n(e))}).catch(s)})},this.getItem=function(e){return new Promise(function(r,a){t.findById(e).then(function(e){return r(n(e))}).catch(a)})},this.clear=function(){return new Promise(function(e,n){u={},t.clear().then(function(){r.default.LocalDB.collection("MessageChunk").clear().then(function(){r.default.LocalDB.collection("Message").clear().then(e).catch(n)}).catch(n)}).catch(n)})},this}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.ChannelBroadcast=function(){var e=[];return this.addCollection=function(t){e.indexOf(t)<0&&e.push(t)},this.removeCollection=function(t){var n=e.indexOf(t);n>=0&&(e[n]._pause(),e.splice(n,1))},this.clearCollection=function(){e=[]},this.pause=function(){for(var t in e)e[t]._pause()},this.reset=function(){for(var t in e)e[t]._reset()},this.upsert=function(t,n){for(var r in e){var a=e[r];a!==n&&a.isMatchingWithQuery(t)&&a._addViewItem(t)}},this.update=function(t,n){for(var r in e){var a=e[r];a!==n&&a.isMatchingWithQuery(t)&&a.channels.map(function(e){return e.url}).indexOf(t.url)>=0&&a._addViewItem(t)}},this.remove=function(t,n){for(var r in e){var a=e[r];a!==n&&a.isMatchingWithQuery(t)&&a._removeViewItem(t)}},this}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=c(n(12)),i=n(14),u=n(4),s=n(15),o=c(n(0));function c(e){return e&&e.__esModule?e:{default:e}}var l=null,f=new WeakMap,h=new WeakMap,d=new WeakMap,v=new WeakMap,y="syncManager_messageManager_connectionHandler_"+(new Date).getTime(),m="syncManager_messageManager_channelHandler_"+(new Date).getTime(),p=function(){function e(t){var n=this;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),l)return l;l=this;var r=this.sb=t,a=new i.MessageContainer(r),c=new u.MessageChunkContainer(r),p=new s.MessageBroadcast;f.set(this,[]),d.set(this,a),h.set(this,c),v.set(this,p);var g=new r.ConnectionHandler;g.onReconnectStarted=function(){p.pause()},g.onReconnectSucceeded=function(){p.reset()},r.addConnectionHandler(y,g);var b=new r.ChannelHandler;Object.keys(b).forEach(function(e){b[e]=function(){var t=f.get(n);if(Array.isArray(t))switch(e){case"onMessageReceived":a.upsert(arguments.length<=1?void 0:arguments[1]).then(function(e){return p.upsert(e)}).catch(function(e){return o.default.throw(e)});break;case"onReadReceiptUpdated":var r=arguments.length<=0?void 0:arguments[0];p.read(r);break;case"onMessageUpdated":a.upsert(arguments.length<=1?void 0:arguments[1]).then(function(e){return p.update(e)}).catch(function(e){return o.default.throw(e)});break;case"onMessageDeleted":var i=parseInt(arguments.length<=1?void 0:arguments[1]);a.remove(i).then(function(){return p.remove(i)}).catch(function(e){return o.default.throw(e)})}}}),r.addChannelHandler(m,b)}return r(e,[{key:"createMessageCollection",value:function(e,t){var n=v.get(this),r=new a.default({manager:this,broadcast:n,messageContainer:d.get(this),chunkContainer:h.get(this),channel:e,filter:t});return r&&n.addCollection(r),r}},{key:"removeMessageCollection",value:function(e){v.get(this).removeCollection(e)}},{key:"clearCache",value:function(){var e=d.get(this),t=h.get(this);e.clear(),t.clear()}},{key:"syncChangeLog",value:function(e,t){var n=this,r=d.get(this),a=v.get(this),i="last-changeLog-token-"+e.url;t||(t=function(){});var u=window.localStorage,s=u.getItem(i)||null;if(s)e.getMessageChangeLogsByToken(s,function(s,c){if(n.sb.getErrorFirstCallback()){var l=s;s=c,c=l}c||(s.updatedMessages.forEach(function(e){r.getItem(e.messageId).then(function(t){r.upsert(e).then(function(e){(!t||!t.isEqual(e))&&a.update(e)}).catch(function(e){return o.default.throw(e)})})}),s.deletedMessageIds.forEach(function(e){r.remove(e).then(function(){return a.remove(e)}).catch(function(e){return o.default.throw(e)})}),u.setItem(i,s.token),s.hasMore?n.syncChangeLog(e,t):t())});else{var c=(new Date).getTime()-15e3;e.getMessageChangeLogsByTimestamp(c,function(s,c){if(n.sb.getErrorFirstCallback()){var l=s;s=c,c=l}c||(s.updatedMessages.forEach(function(e){r.getItem(e.messageId).then(function(t){r.upsert(e).then(function(e){(!t||!t.isEqual(e))&&a.update(e)}).catch(function(e){return o.default.throw(e)})})}),s.deletedMessageIds.forEach(function(e){r.remove(e).then(function(){return a.remove(e)}).catch(function(e){return o.default.throw(e)})}),u.setItem(i,s.token),s.hasMore?n.syncChangeLog(e,t):t())})}}},{key:"start",value:function(){v.get(this).reset()}},{key:"stop",value:function(){v.get(this).pause()}},{key:"reset",value:function(){l&&(l.clearCache(),l.sb.removeConnectionHandler(y),l.sb.removeChannelHandler(m),l=null)}}],[{key:"instance",get:function(){return l}}]),e}();t.default=p},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=o(n(5)),i=o(n(0)),u=o(n(3)),s=n(4);function o(e){return e&&e.__esModule?e:{default:e}}var c=new WeakMap,l=new WeakMap,f=new WeakMap,h=new WeakMap,d=new a.default,v=function(){function e(t){var n=t.manager,r=t.broadcast,i=t.messageContainer,u=t.chunkContainer,o=t.channel,d=t.filter;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.manager=n,this.channel=o,this.filter=d||s.MessageChunk.getDefaultFilter(),this.filter.limit||(this.filter.limit=20),this.isLoading=!1,this.currentChunk=null,this.messages=[],this.handlers={},this.viewMutex=new a.default;var v=0;c.set(this,function(){return++v}),l.set(this,r),f.set(this,i),h.set(this,u),this.manager.syncChangeLog(this.channel)}return r(e,[{key:"_pause",value:function(){if(this.isLoading=!1,this.currentChunk){var e=h.get(this);this.currentChunk.isSynced=!1,e.upsert(this.currentChunk)}}},{key:"_reset",value:function(){var e=this;d.lock(function(t){e.loadPreviousMessages(function(n){n||e.manager.syncChangeLog(e.channel,function(){t()})})})}},{key:"_setCurrentChunk",value:function(e){(this.currentChunk=e,this.currentChunk instanceof s.MessageChunk)&&h.get(this).upsert(this.currentChunk)}},{key:"getIndex",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=0;n<t.length;n++)if(e.reqId&&e.reqId===t[n].reqId||e.messageId===t[n].messageId)return n;return-1}},{key:"findIndex",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=t.length,r=0;r<t.length;r++)if(this.filter.reverse){if(t[r].createdAt<=e.createdAt){n=r;break}}else if(t[r].createdAt>=e.createdAt){n=r;break}return n}},{key:"_loadPreviousMessagesFromCache",value:function(e){var t=this,n=function(e){f.get(t).loadChunkMessages(t.currentChunk,{offset:t.currentChunk?t.currentChunk.previousCacheOffset:0,limit:t.filter.limit,orderBy:"createdAt",desc:!0}).then(function(n){for(var r in t.currentChunk.previousCacheOffset+=n.length,t.filter.reverse||(n=n.reverse()),n){var a=t.messages.map(function(e){return e.messageId}).indexOf(n[r].messageId);(a<0||!t.messages[a].isEqual(n[r]))&&t._addViewItem(n[r])}e(null,n)}).catch(e)};if(this.currentChunk)n(e);else{var r=h.get(this),a=(new Date).getTime();r.getLatestChunkByTimestamp(this.channel.url,this.filter,a).then(function(r){t.currentChunk=r,t.currentChunk?(t.currentChunk.previousCacheOffset=0,n(e)):e(null,[])}).catch(e)}}},{key:"loadPreviousMessages",value:function(e){var t=this;e||(e=function(){}),this.isLoading?e(null):(this.isLoading=!0,this._loadPreviousMessagesFromCache(function(n,r){if(n)t.isLoading=!1,e(n);else{var a=t.currentChunk&&t.currentChunk.isSynced?t.currentChunk.startAt:(new Date).getTime(),u=t.currentChunk&&t.currentChunk.isSynced?t.filter.limit-r.length:t.filter.limit;u>0?t.channel.getPreviousMessagesByTimestamp(a,!1,u,t.filter.reverse||!1,t.filter.messageType||"",t.filter.customType||"",function(n,r){var a=t.manager.sb,i=a.getConnectionState()===a.ConnectionState.OPEN;if(a.getErrorFirstCallback()){var u=n;n=r,r=u}if(Array.isArray(n)&&n.length>0){var o=l.get(t),c=h.get(t),d=f.get(t),v=new s.MessageChunk(t.channel.url,t.filter);for(var y in v.isSynced=i,n)v.extendWithMessage(n[y]);t.currentChunk?t.currentChunk.isSynced?(t.currentChunk.extendWithChunk(v),c.mergePreviousChunkOverlap(t.currentChunk)):t.currentChunk.isSame(v)?t.currentChunk.isSynced=i:t.currentChunk.isOverlap(v)?(t.currentChunk.isSynced=i,t.currentChunk.extendWithChunk(v),c.mergePreviousChunkOverlap(t.currentChunk)):(t._clearViewItem(),t._setCurrentChunk(v)):t._setCurrentChunk(v);var m=[];n.forEach(function(e){m.push(new Promise(function(n,r){d.getItem(e.messageId).then(function(a){var i=t.messages.map(function(e){return e.messageId}).indexOf(e.messageId)>=0;d.upsert(e).then(function(e){var r=!a||!a.isEqual(e);r&&o.update(e,t),i&&!r||t._addViewItem(e),n()}).catch(r)}).catch(r)}))}),Promise.all(m).then(function(){t.currentChunk.previousCacheOffset=t.messages.length,t.isLoading=!1,e(null)}).catch(function(n){t.isLoading=!1,e(n)})}else t.isLoading=!1,e(r)}):(t.isLoading=!1,e(new i.default("Message: Connection required")))}}))}},{key:"isMatchingWithFilter",value:function(e){return this.filter?e.channelUrl===this.channel.url&&((!this.filter.messageType||this.filter.messageType===e.messageType)&&((!this.filter.customType||this.filter.customType===e.customType)&&!(Array.isArray(this.filter.senderUserIds)&&this.filter.senderUserIds.length>0&&e.sender&&this.filter.senderUserIds.indexOf(e.sender.userId)<0))):e.channelUrl===this.channel.url}},{key:"_addViewItem",value:function(e){var t=this;this.viewMutex.lock(function(n){var r=c.get(t)(),a=t.getIndex(e,t.messages),i=t.findIndex(e,t.messages),s=a<0?u.default.Action.INSERT:u.default.Action.UPDATE;for(var o in a<0?t.messages.splice(i,0,e):e.messageId&&(t.messages[a]=e),t.handlers)"function"==typeof t.handlers[o]&&t.handlers[o](new u.default({taskNumber:r,action:s,item:e}));n()})}},{key:"_removeViewItem",value:function(e){var t=this;this.viewMutex.lock(function(n){for(var r in t.messages)if(e===t.messages[r].messageId){var a=t.messages.splice(r,1),i=c.get(t)(),s=u.default.Action.REMOVE;for(var o in t.handlers)"function"==typeof t.handlers[o]&&t.handlers[o](new u.default({taskNumber:i,action:s,item:a.length>0?a[0]:{messageId:e}}));break}n()})}},{key:"_clearViewItem",value:function(){var e=this;this.currentChunk=null,this.messages=[],this.viewMutex.lock(function(t){var n=c.get(e)(),r=u.default.Action.CLEAR;for(var a in e.handlers)"function"==typeof e.handlers[a]&&e.handlers[a](new u.default({taskNumber:n,action:r}));t()})}},{key:"appendMyMessage",value:function(e){var t=this.manager.sb;if(!e.sender||!t.currentUser||e.sender.userId!==t.currentUser.userId)throw new i.default("Can't append other's message");if(e.messageId){var n=l.get(this);f.get(this).upsert(e).then(function(e){return n.upsert(e)})}else this._addViewItem(e)}},{key:"updateMyMessage",value:function(e){var t=this.manager.sb;if(!e.sender||!t.currentUser||e.sender.userId!==t.currentUser.userId)throw new i.default("Can't update other's message");if(e.messageId){var n=l.get(this);f.get(this).upsert(e).then(function(e){return n.upsert(e)})}else this._addViewItem(e)}},{key:"removeMyMessage",value:function(e){var t=this.manager.sb;if(!e.sender||!t.currentUser||e.sender.userId!==t.currentUser.userId)throw new i.default("Can't remove other's message");if(e.messageId){var n=l.get(this);f.get(this).remove(e).then(function(e){return n.remove(e)})}else this._removeViewItem(e)}},{key:"subscribe",value:function(e,t){this.handlers[e]=t}},{key:"unsubscribe",value:function(e){this.handlers[e]&&delete this.handlers[e]}}]),e}();t.default=v},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};t.deepEqual=function e(t,n){var a=void 0===t?"undefined":r(t),i=void 0===n?"undefined":r(n);return!t||!n||"object"!==a||a!==i||t instanceof Date?t instanceof Date?t.getTime()===n.getTime():"function"===a&&"function"===i||t===n:Object.keys(t).length===Object.keys(n).length&&Object.keys(t).every(function(r){return e(t[r],n[r])})},t.createId=function(){var e=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?n:3&n|8).toString(16)})}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MessageContainer=void 0;var r=i(n(1)),a=i(n(2));function i(e){return e&&e.__esModule?e:{default:e}}var u={};t.MessageContainer=function(e){var t=r.default.LocalDB.collection("Message"),n=function(t){var n=null;return t&&("user"===t.messageType?n=e.UserMessage.buildFromSerializedData(t):"file"===t.messageType?n=e.FileMessage.buildFromSerializedData(t):"admin"===t.messageType&&(n=e.AdminMessage.buildFromSerializedData(t))),n};return this.query=function(e,r){return new Promise(function(i,s){var o=new a.default.Query(e);r&&(o.offset=r.offset||0,o.limit=r.limit||20,o.orderBy=r.orderBy||"createdAt",o.desc=!r.hasOwnProperty("desc")||r.desc),t.find(o).then(function(e){var t=[];for(var r in e){var a=n(e[r]);t.push(a),u[a.messageId]=a}i(t)}).catch(s)})},this.upsert=function(e){return new Promise(function(r,a){(function(e){return u[e.messageId]=e,t.upsert(u[e.messageId].serialize())})(e).then(function(e){return r(n(e))}).catch(a)})},this.remove=function(e){return new Promise(function(n,r){(function(e){return u[e]&&delete u[e],t.remove(e)})(e).then(function(){return n(e)}).catch(r)})},this.getItem=function(e){return new Promise(function(r,a){t.findById(e).then(function(e){return r(n(e))}).catch(a)})},this.clear=function(){return u={},t.clear()},this.loadChunkMessages=function(e,r){return r||(r={}),new Promise(function(i,u){var s={channelUrl:e.channelUrl,createdAt:{">=":e.startAt,"<=":e.endAt}};e.filter.messageType&&(s.messageType=e.filter.messageType),e.filter.customType&&(s.customType=e.filter.customType),e.filter.senderUserIds&&e.filter.senderUserIds.length>0&&(s["sender.userId"]={"/in":e.filter.senderUserIds});var o=new a.default.Query(s);o.orderBy=r.orderBy||"createdAt",o.desc=!r.hasOwnProperty("desc")||r.desc,o.offset=r.offset||0,o.limit=r.limit||1/0,t.find(o).then(function(e){var t=[];for(var r in e)t.push(n(e[r]));i(t)}).catch(u)})},this}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MessageBroadcast=void 0;var r=n(4);t.MessageBroadcast=function(){var e=[];return this.addCollection=function(t){e.indexOf(t)<0&&e.push(t)},this.removeCollection=function(t){var n=e.indexOf(t);n>=0&&(e[n]._pause(),e.splice(n,1))},this.clearCollection=function(){e=[]},this.pause=function(){for(var t in e)e[t]._pause()},this.reset=function(){for(var t in e)e[t]._reset()},this.upsert=function(t,n){for(var a in e){var i=e[a];if(i!==n&&i.isMatchingWithFilter(t)){var u=null;i.currentChunk?!i.currentChunk.isSynced&&i.messages.map(function(e){return e.messageId}).indexOf(t.messageId)<0&&(u=new r.MessageChunk(i.channel.url,i.filter)):u=new r.MessageChunk(i.channel.url,i.filter),u&&(u.isSynced=!0,u.extendWithMessage(t),i._clearViewItem(),i._setCurrentChunk(u)),i._addViewItem(t)}}},this.update=function(t,n){for(var r in e){var a=e[r];a!==n&&a.isMatchingWithFilter(t)&&a.messages.map(function(e){return e.messageId}).indexOf(t.messageId)>=0&&a._addViewItem(t)}},this.read=function(t,n){for(var r in e){var a=e[r];if(a!==n&&a.channel.url===t.url)for(var i in a.messages)a._addViewItem(a.messages[i])}},this.remove=function(t,n){for(var r in e){var a=e[r];a!==n&&a._removeViewItem(t)}},this}}]).default});